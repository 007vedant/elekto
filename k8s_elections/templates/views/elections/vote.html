{% extends 'layouts/app.html' %}

{% block header %}
<h1>{% block title %}{{ election['name'] }}{% endblock %}</h1>
{% endblock %}

{% block breadcrums %}
<a href="{{ url_for('elections') }}" class="breadcrums">elections</a>
<a href="{{ url_for('elections_single', eid=election['key']) }}" class="breadcrums">{{ election['name'] }}</a>
<a href="" class="breadcrums breadcrums-active">vote</a>
{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="space--md pb-1rem">
        <div class="border--bottom pb-10px mb-1rem">
            <h1 class="title title-has-subtitle pb-0">
                {{ election['name'] }}
            </h1>
            <span>{{ election['organization'] }}</span>
        </div>
        <p class="disclaimer">
            The poll ends <b>{{ election['end_datetime'] }}</b>.
            The poll is supervised by
            <b>
                {% for eo in election['election_officers'] %}
                <a class="text-dark" target="__blank" href="https://github.com/{{ eo }}">
                    {{ eo + ', ' if election['election_officers']|length > loop.index else eo + '.' }}
                </a>
                {% endfor %}
            </b>
            Contact the poll supervisor if you need help.
        </p>
    </div>
    <div class="space--md pt-0">
        <h1 class="subtitle border--bottom">
            Candidates
        </h1>
        <div>
            <form action="" method="post">
                <div id="draggable">
                    {% for candidate in candidates %}
                    <div class="row border--bottom draggable-row" id="div-{{ candidate['key'] }}"
                        data-candidate="{{candidate['key']}}" data-rank="100000000">
                        <div class="col-6">
                            <span class="row-title">
                                {{ candidate['name'] }}
                            </span>
                        </div>
                        <div class="col-6 text--right">
                            <select class="input" name="candidate@{{ candidate['key'] }}"
                                data-candidate="{{candidate['key']}}" id="select-{{ candidate['key'] }}"
                                onchange="handleChange(this);">
                                <option value="100000000">No opinion</option>
                                {% for k in range(1, candidates|length + 1) %}
                                <option value="{{k}}" {% if candidates|length==k %}selected{% endif %}>{{k}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-10px">
                    <small>Enter a password to secure you ballot. You will need this password if you wish to delete or
                        edit your ballot. <br /></small>
                    <input class="input" type="password" name="password" placeholder="password" required>
                </div>
                <div class="mt-1rem">
                    <button class="btn btn-grey" type="submit">Submit Vote</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script>

    $(function () {
        $("#draggable").sortable();
        $("#draggable").disableSelection();
    });

    const update_candidate = (candidate, rank) => {
        $(`#div-${candidate}`).attr('data-rank', rank);
        $(`#select-${candidate}`).val(rank);
    }

    const sort = (index = null) => {
        $("#draggable").each(function () {
            $(this).html($(this).children('div').sort(function (a, b) {
                return ($(b).data('rank')) < ($(a).data('rank')) ? 1 : -1;
            }));
        });
    }

    $("#draggable").on("sortstop", function (event, ui) {
        var children = $('#draggable').children('div');
        var rank = ui.item.index() + 1;
        if (rank != 1) {
            var hi = children[ui.item.index() - 1].dataset.rank;
            console.log(hi)
            if (hi != 100000000 && hi < children.length) {
                rank = parseInt(hi) + 1;
            }
            console.log(rank)
        }
        update_candidate(ui.item.data('candidate'), rank);
        sort();
    });

    const handleChange = (e) => {
        update_candidate(e.dataset.candidate, e.value);
        sort();
    }

</script>
{% endblock %}